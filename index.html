<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“†å•¦Aå¤¢çš„å¤¢å¢ƒæ‰‹å¸³</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* --- è®Šæ•¸å®šç¾© --- */
        :root {
            --dora-blue: #00a0e9;
            --dora-pink: #e73b2a;
            --dora-yellow: #fce205;
            --text-color: #5d4037;
            --bg-color: #e0f2fe;
            --card-bg: #ffffff;
            --card-border: #ffffff;
            --input-bg: #fafafa;
            --overlay-color: rgba(255, 255, 255, 0.7);
            --shadow-color: rgba(0,160,233, 0.1);
        }

        [data-theme="dark"] {
            --dora-blue: #4fc3f7;
            --dora-pink: #ff6b6b;
            --dora-yellow: #fdd835;
            --text-color: #e0e0e0;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --card-border: #334155;
            --input-bg: #334155;
            --overlay-color: rgba(15, 23, 42, 0.9);
            --shadow-color: rgba(0,0,0, 0.5);
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            margin: 0; padding: 0;
            color: var(--text-color);
            background-color: var(--bg-color);
            background-image: url('img_bg.jpg');
            background-size: 300px; background-repeat: repeat;
            min-height: 100vh;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay-color);
            backdrop-filter: blur(3px); z-index: -1;
            transition: background 0.5s ease;
        }

        /* å°è¦½åˆ— */
        .navbar {
            background: var(--card-bg); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
            border-bottom: 4px solid var(--dora-blue);
            transition: background 0.5s ease;
        }
        .menu-icon { width: 30px; height: 20px; position: relative; cursor: pointer; }
        .menu-icon span {
            display: block; position: absolute; height: 3px; width: 100%;
            background: var(--dora-blue); border-radius: 9px; left: 0;
            transition: .25s ease-in-out;
        }
        .menu-icon span:nth-child(1) { top: 0px; }
        .menu-icon span:nth-child(2) { top: 9px; }
        .menu-icon span:nth-child(3) { top: 18px; }
        .nav-title { font-weight: 700; font-size: 1.1rem; color: var(--dora-blue); letter-spacing: 1px; }

        /* å¤œé–“é–‹é—œ */
        .theme-switch {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--dora-yellow);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
            font-size: 1rem; font-weight: bold; color: #5d4037;
            cursor: pointer; z-index: 900;
            border: 3px solid var(--text-color);
            transition: transform 0.2s;
        }
        .theme-switch:active { transform: scale(0.9); }

        /* å´é‚Šæ¬„ */
        .sidebar {
            height: 100%; width: 260px; position: fixed; top: 0; left: -270px;
            background: var(--card-bg); z-index: 200; transition: 0.4s;
            box-shadow: 5px 0 20px rgba(0,0,0,0.2); padding-top: 30px;
            border-right: 6px solid var(--dora-yellow);
            overflow-y: auto; /* å…è¨±é¸å–®å¤ªé•·æ™‚æ²å‹• */
        }
        .sidebar.active { left: 0; }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .avatar-crop {
            width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--dora-blue);
            margin: 0 auto 10px auto; overflow: hidden; background: #fff;
        }
        .avatar-crop img { width: 100%; height: 100%; object-fit: cover; }
        .nav-item {
            display: block; padding: 15px 30px; margin: 5px 15px;
            text-decoration: none; color: var(--text-color); font-weight: 700;
            border-radius: 10px; transition: 0.2s; border-left: 5px solid transparent;
        }
        .nav-item:hover, .nav-item.active-link { 
            background: var(--input-bg); color: var(--dora-blue); border-left-color: var(--dora-blue);
        }
        .overlay-click { display: none; position: fixed; top:0; left:0; width:100%; height:100%; z-index:150; background:rgba(0,0,0,0.3); }
        .overlay-click.active { display: block; }

        /* å®¹å™¨èˆ‡å…ƒä»¶ */
        .container { max-width: 500px; margin: 0 auto; padding: 20px; display: none; animation: fadeIn 0.4s ease; padding-bottom: 80px; }
        .container.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }

        .top-banner { text-align: center; margin-top: -10px; margin-bottom: 25px; }
        .top-banner img { width: 100%; max-width: 280px; height: auto; filter: drop-shadow(0 5px 8px var(--shadow-color)); }

        .card {
            background: var(--card-bg); border-radius: 20px; padding: 25px; margin-bottom: 25px;
            box-shadow: 0 5px 20px var(--shadow-color); border: 2px solid var(--card-border);
            position: relative; overflow: hidden; transition: background 0.5s;
        }
        h2 { 
            margin-top: 0; color: var(--dora-blue); font-size: 1.2rem; 
            border-bottom: 2px dashed rgba(0,0,0,0.1); padding-bottom: 10px; margin-bottom: 15px;
        }
        [data-theme="dark"] h2 { border-color: rgba(255,255,255,0.1); }
        .small-desc { font-size: 0.9rem; color: #888; margin-bottom: 10px; line-height: 1.5; }
        .card-thumb { width: 100%; height: 120px; object-fit: cover; object-position: center; border-radius: 10px; margin-bottom: 15px; }
        .card-thumb.contain { object-fit: contain; background: var(--input-bg); }

        input, textarea {
            width: 100%; padding: 12px; border: 2px solid var(--card-border);
            border-radius: 12px; font-size: 1rem; font-family: 'Zen Maru Gothic';
            box-sizing: border-box; background: var(--input-bg); outline: none; margin: 5px 0; color: var(--text-color);
            transition: background 0.5s;
        }
        input:focus { border-color: var(--dora-blue); }

        button {
            width: 100%; padding: 12px; border: none; border-radius: 50px;
            font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px;
            font-family: 'Zen Maru Gothic'; color: white; transition: 0.2s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(3px); box-shadow: none; }
        .btn-blue { background: var(--dora-blue); }
        .btn-green { background: #2ecc71; } 
        .btn-pink { background: var(--dora-pink); }
        .btn-yellow { background: var(--dora-yellow); color: #5d4037; }
        .btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .btn-group button { margin-top: 0; font-size: 0.9rem; padding: 10px; }

        .result-box {
            margin-top: 20px; padding: 15px; background: var(--input-bg);
            border-radius: 12px; border: 2px solid var(--dora-blue);
            color: var(--text-color); display: none; text-align: center; font-weight: bold;
        }
        .time-tag {
            display: inline-block; background: var(--dora-yellow); color: #5d4037;
            padding: 5px 12px; border-radius: 20px; margin: 4px; font-size: 0.95rem;
        }

        /* èŠ±åœ’æ¨£å¼ */
        .garden-area {
            text-align: center; min-height: 300px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
        }
        .flower-pot {
            width: 200px; height: 250px; position: relative;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .flower-img {
            max-width: 100%; max-height: 100%;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
            transition: all 0.5s ease;
        }
        [data-theme="dark"] .flower-img {
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.2));
        }

        /* æ¾†æ°´å‹•ç•« */
        .water-can {
            position: absolute; top: 0; right: 0; width: 80px; display: none; z-index: 50;
        }
        .watering .water-can {
            display: block;
            animation: pourWater 2s ease-in-out forwards;
        }
        @keyframes pourWater {
            0% { transform: rotate(0deg) translate(0, 0); opacity: 0; }
            20% { transform: rotate(-30deg) translate(-40px, 20px); opacity: 1; }
            80% { transform: rotate(-30deg) translate(-40px, 20px); opacity: 1; }
            100% { transform: rotate(0deg) translate(0, 0); opacity: 0; }
        }

        .growth-bar {
            width: 100%; height: 10px; background: #eee; border-radius: 5px;
            margin-top: 20px; overflow: hidden;
        }
        .growth-fill {
            height: 100%; background: var(--dora-green); width: 0%;
            transition: width 0.5s; background: #2ecc71;
        }
        .flower-select { display: flex; gap: 5px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .flower-option { padding: 8px 12px; border: 2px solid #ddd; border-radius: 20px; cursor: pointer; font-size: 0.85rem; color: #aaa; }
        .flower-option.active { border-color: var(--dora-blue); color: var(--dora-blue); font-weight: bold; background: var(--input-bg); }
        .flower-option.locked { opacity: 0.5; cursor: not-allowed; }

        /* å½©è›‹å‹•ç•« (Stop Motion Overlay) */
        .egg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 999; display: none;
            justify-content: center; align-items: center;
            flex-direction: column;
        }
        [data-theme="dark"] .egg-overlay { background: rgba(15, 23, 42, 0.98); }

        .egg-content { text-align: center; }
        .egg-img {
            width: 300px; height: 300px;
            object-fit: contain;
            border-radius: 20px;
            background: white;
            border: 8px solid white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .egg-text {
            margin-top: 20px; font-size: 1.2rem; font-weight: bold; color: var(--dora-blue);
            opacity: 0; animation: fadeIn 1s ease forwards; animation-delay: 0.5s;
        }
        @keyframes fadeIn { to {opacity: 1;} }

        /* ç´€éŒ„èˆ‡æ—¥è¨˜ */
        .history-list { list-style: none; padding: 0; }
        .history-item {
            background: var(--card-bg); margin-bottom: 15px; padding: 20px;
            border-radius: 15px; border-left: 8px solid var(--dora-blue);
            box-shadow: 2px 2px 10px var(--shadow-color); position: relative; border: 1px solid var(--card-border);
        }
        
        /* åˆªé™¤æŒ‰éˆ• (çµ•å°ç½®ä¸­) */
        .del-btn { 
            position: absolute; top: 15px; right: 15px; 
            width: 32px; height: 32px; 
            border-radius: 50%; background: #eee; 
            color: #888; border: none; 
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; cursor: pointer; padding: 0; padding-bottom: 2px;
            line-height: 1;
        }
        .del-btn:hover { background: #ffcccc; color: red; }
        
        .date-badge { display: inline-block; background: var(--input-bg); padding: 3px 10px; border-radius: 5px; font-size: 0.8rem; margin-bottom: 8px; color: var(--text-color); }
        .data-row { display: flex; justify-content: space-between; margin-top: 5px; }
        .label { color: #888; font-size: 0.8rem; margin-right: 5px; }
        .duration-info {
            background: var(--dora-yellow); color: #5d4037;
            padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: bold;
            margin-top: 8px; display: inline-block;
        }

        .diary-paper {
            background: var(--card-bg); background-image: radial-gradient(var(--card-border) 1px, transparent 1px);
            background-size: 20px 20px; padding: 25px; border-radius: 5px;
            box-shadow: 0 5px 10px var(--shadow-color); margin-bottom: 20px; border-top: 10px solid var(--dora-blue);
        }

        /* æ¸…é™¤æŒ‰éˆ•ç½®åº•æ¨£å¼ */
        .clear-zone {
            margin-top: 60px; padding-top: 30px; border-top: 1px dashed #ddd; text-align: center; opacity: 0.7;
        }
        .clear-btn-bottom {
            background: transparent; color: #999; font-size: 0.75rem; padding: 8px 15px;
            border: 1px solid #ccc; border-radius: 50px; font-weight: normal; width: auto; box-shadow: none;
        }
        .clear-btn-bottom:hover { background: #fff0f0; color: #ff6b6b; border-color: #ff6b6b; }

    </style>
</head>
<body>
    <div class="bg-overlay"></div>

    <div id="eggOverlay" class="egg-overlay">
        <div class="egg-content">
            <img id="eggAnim" src="movie_1.png" class="egg-img">
            <div class="egg-text">èŠ±æœµé•·å¤§äº†ï¼</div>
        </div>
    </div>

    <div class="theme-switch" onclick="toggleTheme()">
        <span id="themeIcon">æ—¥</span>
    </div>

    <!-- å°è¦½åˆ— -->
    <div class="navbar">
        <div class="menu-icon" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
        <div class="nav-title" id="navTitle">ä»»æ„é–€</div>
        <div style="width:30px;"></div>
    </div>

    <!-- å´é‚Šé¸å–® -->
    <div class="overlay-click" onclick="toggleMenu()"></div>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="avatar-crop"><img src="img_circle.jpg"></div>
            <h3 style="color:var(--text-color); margin:0;">ç™¾å¯¶è¢‹é¸å–®</h3>
        </div>
        <a class="nav-item active-link" id="nav-home" onclick="goPage('home')">ç¡çœ é“å…·å±‹</a>
        <a class="nav-item" id="nav-garden" onclick="goPage('garden')">ç§˜å¯†èŠ±åœ’</a>
        <a class="nav-item" id="nav-history" onclick="goPage('history')">å¤¢å¢ƒç´€éŒ„æ›¸</a>
        <a class="nav-item" id="nav-diary" onclick="goPage('diary')">å¿ƒæƒ…æ—¥è¨˜æœ¬</a>
        
        <!-- NEW: ç³»çµ±è¨­å®šèˆ‡å‚™ä»½ -->
        <div style="border-top:1px dashed #ddd; margin:15px; padding-top:10px;">
            <div style="color:#aaa; font-size:0.8rem; padding-left:15px; margin-bottom:5px;">é“å…·è¨­å®š</div>
            <a class="nav-item" onclick="goPage('settings')">ğŸ› ï¸ å‚™ä»½èˆ‡åˆ†äº«</a>
        </div>
    </div>

    <!-- é é¢ 1: é¦–é  -->
    <div id="home" class="container active">
        <div class="top-banner"><img src="img_header.jpg"></div>

        <div class="card" style="border-top: 5px solid #2ecc71;">
            <h2>å¦‚æœé›»è©±äº­ï¼šåˆ†æ®µç¡çœ </h2>
            <div style="display:flex; align-items:center; gap:10px;">
                <label style="color:#888;">èµ·åºŠæ™‚é–“</label>
                <input type="time" id="splitWake" value="07:30">
            </div>
            <button class="btn-green" onclick="calcSplit()">è¨ˆç®—å…¥ç¡æ™‚é–“</button>
            <div id="resSplit" class="result-box"></div>
        </div>

        <div class="card" style="border-top: 5px solid var(--dora-pink);">
            <img src="img_doors.jpg" class="card-thumb contain">
            <h2>ä»»æ„é–€ï¼šç¾åœ¨å»ç¡</h2>
            <div class="btn-group">
                <button class="btn-pink" onclick="calcNow(5)">5 åˆ†é˜</button>
                <button class="btn-pink" onclick="calcNow(15)">15 åˆ†é˜</button>
                <button class="btn-pink" onclick="calcNow(25)">25 åˆ†é˜</button>
            </div>
            <div id="resNow" class="result-box"></div>
        </div>

        <div class="card">
            <h2>å¿«é€Ÿå­˜å…¥ç´€éŒ„</h2>
            <p class="small-desc">è£œç™»æ˜¨å¤©çš„ç´€éŒ„ä¹Ÿå¯ä»¥é¸æ—¥æœŸå–”ï¼</p>
            
            <div style="margin-bottom:10px;">
                <label class="label">æ—¥æœŸ</label>
                <input type="date" id="recordDate">
            </div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label class="label">å…¥ç¡</label>
                    <input type="time" id="t1" value="23:00">
                </div>
                <div style="flex:1">
                    <label class="label">èµ·åºŠ</label>
                    <input type="time" id="t2" value="07:00">
                </div>
            </div>

            <div style="margin-top:15px;">
                <label class="label">å¤¢å¢ƒè¨˜äº‹ (é¸å¡«)</label>
                <textarea id="quickDream" rows="2" placeholder="å‰›ç¡é†’è¨˜å¾—ä»€éº¼å¤¢å—ï¼Ÿå¿«è¨˜ä¸‹ä¾†..."></textarea>
            </div>

            <button class="btn-blue" onclick="quickSave()">å­˜æª”ä¸¦æ¾†æ°´</button>
        </div>
    </div>

    <!-- é é¢ 2: ç§˜å¯†èŠ±åœ’ -->
    <div id="garden" class="container">
        <div class="card" style="border-top: 5px solid var(--dora-yellow); min-height:400px;">
            <h2>æˆ‘çš„å¤¢å¢ƒèŠ±åœ’</h2>
            <p class="small-desc" style="text-align:center;">ç´¯ç©ç¡çœ ç´€éŒ„è®“èŠ±é•·å¤§ï¼</p>
            
            <div class="flower-select">
                <div id="sel_1" class="flower-option active" onclick="changeFlower(1)">å‘æ—¥è‘µ</div>
                <div id="sel_2" class="flower-option locked" onclick="changeFlower(2)">ç´…ç«ç‘°</div>
                <div id="sel_3" class="flower-option locked" onclick="changeFlower(3)">ç²‰ç«ç‘°</div>
            </div>

            <div class="garden-area" id="gardenArea">
                <img src="img_watercan.png" class="water-can">
                <div class="flower-pot">
                    <img src="" id="currentFlowerImg" class="flower-img">
                </div>
            </div>
            
            <div style="text-align:center; margin-top:10px;">
                <span id="growthText" style="color:var(--dora-blue); font-weight:bold;"></span>
            </div>
            <div class="growth-bar">
                <div class="growth-fill" id="growthBar"></div>
            </div>
        </div>
    </div>

    <!-- é é¢ 3: ç´€éŒ„æ›¸ -->
    <div id="history" class="container">
        <img src="img_icons.jpg" class="card-thumb" style="height:100px;">
        <div style="background:var(--card-bg); padding:15px; border-radius:12px; margin-bottom:20px; display:flex; gap:10px; align-items:center; border:1px solid var(--card-border);">
            <span style="font-weight:bold; font-size:0.9rem;">æŸ¥è©¢æ—¥æœŸ</span>
            <input type="date" id="filterDate" onchange="renderHistory()" style="margin:0;">
        </div>
        <ul id="historyList" class="history-list"></ul>
        
        <div class="clear-zone">
            <button class="clear-btn-bottom" onclick="clearAllRecs()">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <!-- é é¢ 4: æ—¥è¨˜æœ¬ -->
    <div id="diary" class="container">
        <div class="card">
            <h2>æ’°å¯«æ—¥è¨˜</h2>
            <input type="date" id="dDate">
            <textarea id="dText" rows="6" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿå¯«ä¸‹ä¾†å§..." style="background:var(--input-bg);"></textarea>
            <button class="btn-blue" onclick="saveDiary()">ä¿å­˜æ—¥è¨˜</button>
        </div>
        <div id="diaryList"></div>
    </div>

    <!-- é é¢ 5: ç³»çµ±è¨­å®š (å‚™ä»½èˆ‡åˆ†äº«) -->
    <div id="settings" class="container">
        <div class="card">
            <h2>ğŸ› ï¸ è¨˜æ†¶åå¸ (å‚™ä»½èˆ‡åˆ†äº«)</h2>
            <p class="small-desc">æƒ³æ›æ‰‹æ©Ÿæˆ–å‚³ç´€éŒ„çµ¦æœ‹å‹ï¼Ÿè«‹ä½¿ç”¨é€™è£¡çš„åŠŸèƒ½ã€‚</p>
            
            <div style="margin-bottom:20px; border-bottom:1px dashed #eee; padding-bottom:20px;">
                <h3>ğŸ“¤ åŒ¯å‡º (è£½ä½œè¨˜æ†¶åå¸)</h3>
                <p class="small-desc">æŠŠç¾åœ¨çš„ç´€éŒ„å­˜æˆæª”æ¡ˆï¼Œå¯ä»¥å‚³çµ¦æœ‹å‹æˆ–è‡ªå·±å‚™ä»½ã€‚</p>
                <button class="btn-yellow" onclick="exportData()">ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ</button>
            </div>

            <div>
                <h3>ğŸ“¥ åŒ¯å…¥ (åƒä¸‹è¨˜æ†¶åå¸)</h3>
                <p class="small-desc">è®€å–æœ‹å‹å‚³ä¾†çš„æª”æ¡ˆï¼Œæˆ–æ˜¯é‚„åŸä¹‹å‰çš„å‚™ä»½ã€‚<br><b style="color:var(--dora-pink);">è­¦å‘Šï¼šæœƒè¦†è“‹ç›®å‰çš„ç´€éŒ„å–”ï¼</b></p>
                <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(this)">
                <button class="btn-blue" onclick="document.getElementById('importFile').click()">é¸æ“‡æª”æ¡ˆåŒ¯å…¥</button>
            </div>
        </div>
        <div style="text-align:center; margin-top:20px; font-size:0.8rem; color:#aaa;">
            Doraemon Sleep Diary v21.0
        </div>
    </div>

    <script>
        const FLOWER_CONFIG = {
            1: { stage1: 'flower_1_1.png', stage2: 'flower_1_2.png', stage3: 'flower_1_3.png' },
            2: { stage1: 'flower_1_1.png', stage2: 'flower_1_2.png', stage3: 'flower_2_3.png' },
            3: { stage1: 'flower_1_1.png', stage2: 'flower_1_2.png', stage3: 'flower_2_4.png' }
        };

        // --- åˆå§‹åŒ– ---
        document.getElementById('recordDate').valueAsDate = new Date();
        document.getElementById('dDate').valueAsDate = new Date();

        if(localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').innerText = 'å¤œ';
        }
        
        let gardenData = JSON.parse(localStorage.getItem('doraGarden')) || { type: 1, exp: 0, unlocked: 1 };
        
        // æ¢å¾©ä¸Šæ¬¡ç€è¦½é é¢
        let lastPage = localStorage.getItem('doraLastPage') || 'home';
        goPage(lastPage);

        updateGardenUI();
        renderHistory(); 
        renderDiary();

        // --- å‚™ä»½èˆ‡åˆ†äº«åŠŸèƒ½ (V21.0 New!) ---
        function exportData() {
            const data = {
                doraRecs: localStorage.getItem('doraRecs'),
                doraDiary: localStorage.getItem('doraDiary'),
                doraGarden: localStorage.getItem('doraGarden'),
                theme: localStorage.getItem('theme')
            };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "dora_backup.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            alert("è¨˜æ†¶åå¸è£½ä½œå®Œæˆï¼è«‹å°‡æª”æ¡ˆå‚³é€çµ¦æƒ³åˆ†äº«çš„äººã€‚");
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.doraRecs) localStorage.setItem('doraRecs', data.doraRecs);
                    if(data.doraDiary) localStorage.setItem('doraDiary', data.doraDiary);
                    if(data.doraGarden) localStorage.setItem('doraGarden', data.doraGarden);
                    if(data.theme) localStorage.setItem('theme', data.theme);
                    
                    alert("è¨˜æ†¶åå¸åƒä¸‹å»äº†ï¼è³‡æ–™å·²é‚„åŸã€‚");
                    location.reload(); // é‡æ–°æ•´ç†ä»¥å¥—ç”¨
                } catch (err) {
                    alert("é€™ç‰‡è¨˜æ†¶åå¸å£æ‰äº† (æ ¼å¼éŒ¯èª¤)ï¼");
                }
            };
            reader.readAsText(file);
        }

        // --- é é¢åˆ‡æ› ---
        function toggleMenu() { document.querySelector('.sidebar').classList.toggle('active'); document.querySelector('.overlay-click').classList.toggle('active'); }
        
        function goPage(pid) {
            localStorage.setItem('doraLastPage', pid);
            document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active-link'));
            let targetNav = document.getElementById('nav-' + pid);
            if(targetNav) targetNav.classList.add('active-link');
            
            let titles = {'home':'ç¡çœ é“å…·å±‹', 'garden':'ç§˜å¯†èŠ±åœ’', 'history':'å¤¢å¢ƒç´€éŒ„æ›¸', 'diary':'å¿ƒæƒ…æ—¥è¨˜æœ¬', 'settings':'ç³»çµ±è¨­å®š'};
            document.getElementById('navTitle').innerText = titles[pid];
            
            if(pid === 'history') renderHistory();
            if(document.querySelector('.sidebar').classList.contains('active')) toggleMenu();
        }

        // --- å…¶é¤˜é‚è¼¯ (ç¶­æŒä¸è®Š) ---
        function fmt(d) { return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }
        function calcSplit() {
            let s = document.getElementById('splitWake').value; if(!s) return;
            let t = new Date(); let [h,m] = s.split(':'); t.setHours(h,m,0);
            if(t < new Date()) t.setDate(t.getDate()+1);
            let html = ""; [5, 4, 3].forEach(c => { let slp = new Date(t.getTime() - c*90*60000 - 15*60000); html += `<div style="margin:8px 0; border-bottom:1px solid #eee; padding-bottom:5px;">ç¡ ${c*1.5} å°æ™‚ <span style="float:right; color:var(--dora-blue);">${fmt(slp)} å…¥ç¡</span></div>`; });
            document.getElementById('resSplit').innerHTML = `<div style="text-align:left;">${html}</div>`; document.getElementById('resSplit').style.display = 'block';
        }
        function calcNow(delay) {
            let n = new Date(); n.setMinutes(n.getMinutes() + delay);
            let html = ""; for(let i=4; i<=6; i++) { let w = new Date(n.getTime() + i*90*60000); html += `<span class="time-tag">${fmt(w)}</span>`; }
            document.getElementById('resNow').innerHTML = `<div>${delay} åˆ†é˜å¾Œå…¥ç¡</div><div style="margin-top:5px; color:#666; font-size:0.9rem;">å»ºè­°èµ·åºŠæ™‚é–“</div><div style="margin-top:10px;">${html}</div>`; document.getElementById('resNow').style.display = 'block';
        }
        function getDuration(d, t1, t2) {
            let start = new Date(d + 'T' + t1);
            let end = new Date(d + 'T' + t2);
            if (end < start) end.setDate(end.getDate() + 1); 
            let diff = end - start;
            let hrs = Math.floor(diff / 3600000);
            let mins = Math.round((diff % 3600000) / 60000);
            return `å…± ${hrs}å°æ™‚ ${mins}åˆ†`;
        }
        function updateGardenUI() {
            for(let i=1; i<=3; i++) {
                let el = document.getElementById('sel_'+i);
                if(i <= gardenData.unlocked) {
                    el.className = gardenData.type === i ? 'flower-option active' : 'flower-option';
                    el.classList.remove('locked');
                } else {
                    el.className = 'flower-option locked';
                }
            }
            let stageKey = 'stage1'; let label = "å¹¼è‹—"; let percent = 20;
            if (gardenData.exp >= 6) {
                stageKey = 'stage3'; percent = 100; label = "ç››é–‹";
                if(gardenData.type === gardenData.unlocked && gardenData.unlocked < 3) {
                    gardenData.unlocked += 1;
                    localStorage.setItem('doraGarden', JSON.stringify(gardenData));
                }
            } else if (gardenData.exp >= 3) { stageKey = 'stage2'; percent = 60; label = "æˆé•·ä¸­"; }
            else { stageKey = 'stage1'; percent = 20; label = "å¹¼è‹—"; }

            let imgSrc = FLOWER_CONFIG[gardenData.type][stageKey];
            document.getElementById('currentFlowerImg').src = imgSrc;
            document.getElementById('growthText').innerText = `æˆé•·é€²åº¦ï¼š${label} (ç´¯ç© ${gardenData.exp} ç­†ç´€éŒ„)`;
            document.getElementById('growthBar').style.width = percent + "%";
        }
        function triggerWatering() {
            gardenData.exp += 1; localStorage.setItem('doraGarden', JSON.stringify(gardenData));
            goPage('garden');
            let area = document.getElementById('gardenArea');
            area.classList.remove('watering');
            void area.offsetWidth; 
            area.classList.add('watering');
            if(gardenData.exp === 6) { setTimeout(() => { playEggAnimation(); }, 2000); }
            setTimeout(updateGardenUI, 2500);
        }
        function playEggAnimation() {
            const overlay = document.getElementById('eggOverlay');
            const img = document.getElementById('eggAnim');
            overlay.style.display = 'flex';
            let frame = 1;
            let interval = setInterval(() => {
                frame++;
                if(frame > 12) { clearInterval(interval); setTimeout(() => { overlay.style.display = 'none'; }, 1000); }
                else { img.src = `movie_${frame}.png`; }
            }, 150);
        }
        function changeFlower(type) {
            if(type > gardenData.unlocked) return alert("è«‹å…ˆç¨®å®Œä¸Šä¸€ç¨®èŠ±ï¼");
            if(type !== gardenData.type) {
                if(confirm("è¦æ›ç¨®é€™ç›†èŠ±å—ï¼Ÿ(å¦‚æœæ˜¯æ²’ç¨®éçš„èŠ±ï¼Œè¦å¾é ­é–‹å§‹å–”)")) {
                    gardenData.type = type;
                    if(gardenData.exp < 6) gardenData.exp = 0; 
                    if(type < gardenData.unlocked) gardenData.exp = 6; 
                    localStorage.setItem('doraGarden', JSON.stringify(gardenData));
                    updateGardenUI();
                }
            }
        }
        function quickSave() {
            let dateVal = document.getElementById('recordDate').value;
            let t1 = document.getElementById('t1').value; let t2 = document.getElementById('t2').value;
            let dreamText = document.getElementById('quickDream').value;
            if(!dateVal) return alert("è«‹é¸æ“‡æ—¥æœŸï¼");
            let recs = JSON.parse(localStorage.getItem('doraRecs')) || [];
            recs.unshift({id:Date.now(), date:dateVal, t1, t2});
            localStorage.setItem('doraRecs', JSON.stringify(recs));
            if(dreamText.trim() !== "") {
                let diaries = JSON.parse(localStorage.getItem('doraDiary')) || [];
                diaries.unshift({id:Date.now() + 1, date:dateVal, text: "ã€å¤¢å¢ƒå¿«è¨˜ã€‘\n" + dreamText}); 
                localStorage.setItem('doraDiary', JSON.stringify(diaries));
                document.getElementById('quickDream').value = ""; 
            }
            renderHistory(); renderDiary();
            triggerWatering();
        }
        function toggleTheme() {
            let current = document.documentElement.getAttribute('data-theme');
            let icon = document.getElementById('themeIcon');
            if (current === 'dark') {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light'); icon.innerText = 'æ—¥';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark'); icon.innerText = 'å¤œ';
            }
        }
        function renderHistory() {
            let recs = JSON.parse(localStorage.getItem('doraRecs')) || [];
            let f = document.getElementById('filterDate').value;
            let ul = document.getElementById('historyList'); ul.innerHTML = "";
            let show = f ? recs.filter(r => r.date === f) : recs;
            if(show.length === 0) { ul.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>é€™è£¡ç©ºç©ºçš„ï¼Œå¿«å»ç¡è¦ºå§ï¼</div>"; return;}
            show.forEach(r => { 
                let dur = getDuration(r.date, r.t1, r.t2);
                ul.innerHTML += `<li class="history-item"><span class="date-badge">${r.date}</span><button class="del-btn" onclick="delRec(${r.id})">Ã—</button><div class="data-row"><div><span class="label">å…¥ç¡</span> <b>${r.t1}</b></div><div><span class="label">èµ·åºŠ</span> <b>${r.t2}</b></div></div><div class="duration-info">â±ï¸ ${dur}</div></li>`; 
            });
        }
        function delRec(id) { 
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ\n(èŠ±æœµç¶“é©—å€¼ä¹Ÿæœƒå€’æ‰£å–”)")) return;
            let recs = JSON.parse(localStorage.getItem('doraRecs')) || []; 
            recs = recs.filter(r => r.id !== id); 
            localStorage.setItem('doraRecs', JSON.stringify(recs)); 
            if(gardenData.exp > 0) { gardenData.exp -= 1; localStorage.setItem('doraGarden', JSON.stringify(gardenData)); updateGardenUI(); }
            renderHistory(); 
        }
        function clearAllRecs() { 
            if(confirm("ç¢ºå®šè¦æ’•æ‰æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ(èŠ±æœµä¹Ÿæœƒé‡æ–°é–‹å§‹ç¨®å–”)")) { 
                localStorage.removeItem('doraRecs'); 
                gardenData.exp = 0; localStorage.setItem('doraGarden', JSON.stringify(gardenData)); updateGardenUI();
                renderHistory(); 
            } 
        }
        function saveDiary() {
            let d = document.getElementById('dDate').value; let t = document.getElementById('dText').value;
            if(!t) return alert("è«‹å¯«é»å…§å®¹å§ï¼");
            let diaries = JSON.parse(localStorage.getItem('doraDiary')) || [];
            diaries.unshift({id:Date.now(), date:d, text:t}); 
            localStorage.setItem('doraDiary', JSON.stringify(diaries)); 
            document.getElementById('dText').value=""; renderDiary();
        }
        function renderDiary() {
            let diaries = JSON.parse(localStorage.getItem('doraDiary')) || [];
            let div = document.getElementById('diaryList'); div.innerHTML = "";
            if(diaries.length === 0) { div.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>é‚„æ²’æœ‰æ—¥è¨˜å–”</div>"; return;}
            diaries.forEach(d => {
                div.innerHTML += `<div class="diary-paper"><div style="color:#aaa; font-size:0.8rem; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">${d.date}</div><div style="line-height:1.6; white-space: pre-wrap;">${d.text}</div><div style="text-align:right; margin-top:10px;"><span onclick="delDiary(${d.id})" style="color:#e73b2a; cursor:pointer; font-size:0.8rem; border:1px solid #e73b2a; padding:2px 8px; border-radius:4px;">åˆªé™¤</span></div></div>`;
            });
        }
        function delDiary(id) { let diaries = JSON.parse(localStorage.getItem('doraDiary')) || []; diaries = diaries.filter(d => d.id !== id); localStorage.setItem('doraDiary', JSON.stringify(diaries)); renderDiary(); }
    </script>
</body>
</html>